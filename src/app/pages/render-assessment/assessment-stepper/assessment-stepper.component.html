<div class="d-flex flex-column h-100">
  <nl-assessment-header></nl-assessment-header>
  <div class="col overflow-hidden">
    <div class="container-fluid h-100">
      <ng-container *ngIf="showInstructions">
        <div class="row flex-column gy-2 h-100">
          <div class="col">
            <iframe [src]="instructionsUrl" frameborder="0" width="100%" height="100%"></iframe>
          </div>
          <div class="col-auto mx-auto">
            <button class="p-button" (click)="onInstructionsSubmit()">Next</button>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="showStepper">
        <div class="row h-100">
          <div class="col-lg-9 assessment-question-section">
            <div class="row mt-4 justify-content-center">
              <nl-stepper [selectedIndex]="activeStepIndex">
                <nl-step
                  *ngFor="let step of steps"
                  [completed]="step.completed"
                  [stepControl]="step.stepControl"
                  [title]="step.title"
                  [showSubTitle]="step.showSubTitle"
                  [subTitle]="step.subTitle">
                  <ng-container *ngIf="activeSectionFormGroup">
                    <!-- <ng-container *ngIf="step.stepControl && step.stepControl.get('assessmentId')"> -->
                    <!-- Added above ngIf as instruction page don't have any formGroup controls-->
                    <h5 class="mt-4">Questions</h5>
                    <form [formGroup]="activeSectionFormGroup">
                      <ng-container
                        formArrayName="itemAspectsFormArray"
                        *ngFor="
                          let itemAspect of sections[activeSectionIndex].itemAspects;
                          index as itemAspectIndex
                        ">
                        <div
                          class="assessment-section d-flex justify-content-center align-items-baseline gap-4"
                          *ngIf="itemAspectIndex === activeQuestionIndex">
                          <div class="question-number col-auto mt-4">
                            {{ itemAspectIndex + 1 }}
                          </div>
                          <div
                            [formGroupName]="activeQuestionIndex"
                            class="question-section d-flex flex-column gap-4">
                            <div class="question border border-1 p-2 shadow">
                              <ng-container
                                *ngIf="
                                  itemAspect.questionImage &&
                                    itemAspect.questionImage[selectedLanguage];
                                  else questionTpl
                                ">
                                <img
                                  [src]="itemAspect.questionImage[selectedLanguage]"
                                  alt="question-img"
                                  width="100%"
                                  height="100%" />
                              </ng-container>
                              <ng-template #questionTpl>
                                {{ itemAspect.language[selectedLanguage].split('. ')[1] }}
                              </ng-template>
                            </div>
                            <div class="answer row g-2 justify-content-around">
                              <ng-container
                                *ngFor="let answer of itemAspect.answerOptions; index as ansIndex">
                                <div class="col-auto">
                                  <div class="form-check">
                                    <input
                                      formControlName="selectedOption"
                                      (change)="onAnswerSelection(activeQuestionIndex)"
                                      class="form-check-input"
                                      type="radio"
                                      [value]="answer.choice"
                                      [id]="'ans-' + activeQuestionIndex + '-' + ansIndex" />
                                    <label
                                      class="form-check-label"
                                      [for]="'ans-' + activeQuestionIndex + '-' + ansIndex"
                                      >{{ answer.language[selectedLanguage] }}</label
                                    >
                                  </div>
                                </div>
                              </ng-container>
                            </div>
                            <div
                              class="d-flex justify-content-around pt-4 nl-border-top nl-border-1">
                              <button
                                type="button"
                                class="p-button p-button-secondary text-black fw-bold"
                                [disabled]="activeQuestionIndex === 0"
                                (click)="onBack()">
                                <!-- <i class="nl-icon left-arrow"></i> -->
                                Back
                              </button>
                              <button
                                *ngIf="
                                  activeQuestionIndex !==
                                  sections[activeSectionIndex].itemAspects.length - 1
                                "
                                type="button"
                                class="p-button p-button-warning gap-2"
                                (click)="onSkip(activeQuestionIndex)">
                                Skip for Later
                                <i class="nl-icon right-arrow"></i>
                              </button>
                              <button
                                *ngIf="
                                  activeQuestionIndex ===
                                  sections[activeSectionIndex].itemAspects.length - 1
                                "
                                type="button"
                                class="p-button p-button-primary"
                                (click)="onSubmit()">
                                Submit
                              </button>
                            </div>
                            <div class="row mt-4">
                              <div class="col-12">
                                <div class="d-flex gap-5 justify-content-center">
                                  <div class="not-attempted d-flex gap-2 align-items-center">
                                    <div class="box"></div>
                                    <div class="">Not Attempted</div>
                                  </div>
                                  <div class="attempted d-flex gap-2 align-items-center">
                                    <div class="box"></div>
                                    <div>Attempted</div>
                                  </div>
                                  <div class="skipped d-flex gap-2 align-items-center">
                                    <div class="box"></div>
                                    <div>Skipped</div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </ng-container>
                    </form>
                    <!-- <div>{{ activeSectionFormGroup.value | json }}</div> -->
                    <!-- For debug purpose-->
                  </ng-container>
                </nl-step>
              </nl-stepper>
            </div>
          </div>
          <div class="col-lg-3 h-100 assessment-timer-section">
            <div class="p-3 h-100">
              <div class="row gy-3 flex-column align-items-center h-100">
                <div class="col-lg-auto">
                  <nl-circle-progress
                    [timeInMinutes]="activeAssessment.timeLimit"></nl-circle-progress>
                </div>
                <div class="col-lg-auto">
                  <h5 class="fw-bold">{{ activeAssessment.displayName }}</h5>
                </div>
                <div class="col overflow-auto sub-test-container">
                  <div class="row gy-3">
                    <div
                      [id]="SUB_TEST_CARD_LABEL + i"
                      class="col-lg-12"
                      *ngFor="let section of sections; index as i">
                      <div class="row">
                        <div class="col-lg-12">
                          <div class="section-card nl-border nl-border-1">
                            <div class="section-card-header p-2 d-flex align-items-center">
                              <span class="col-auto">{{ SUB_TEST_LABEL + (i + 1) }}</span>
                              <span
                                class="nl-icon mx-3 d-inline-block"
                                [ngClass]="{
                                  'up-arrow': i === activeSectionIndex,
                                  'down-arrow': i !== activeSectionIndex
                                }"></span>
                              <span class="status text-truncate" *ngIf="i === activeSectionIndex"
                                >In Progress</span
                              >
                            </div>
                            <div class="section-card-body p-2" *ngIf="i === activeSectionIndex">
                              <div class="container-fluid">
                                <div class="row g-2">
                                  <div
                                    class="col-auto"
                                    *ngFor="
                                      let itemAspect of section.itemAspects;
                                      index as childAspectIndex
                                    ">
                                    <div
                                      (click)="activeQuestionIndex = childAspectIndex"
                                      class="count nl-border nl-border-1"
                                      [ngClass]="{
                                        answered: isAnswered(childAspectIndex),
                                        skipped:
                                          isSkipped(childAspectIndex) &&
                                          !isAnswered(childAspectIndex)
                                      }">
                                      {{ childAspectIndex + 1 }}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</div>
